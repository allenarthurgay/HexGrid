<html>
	<body onload="render();">
		<canvas id="canvas" width="320" height="240" style="border: 1px solid #000">
		</canvas>
        <script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

        <script id="shader-fs" type="x-shader/x-fragment">
            precision mediump float;

            void main(void) {
                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
            }
        </script>

        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;

            uniform mat4 uMVMatrix;

            void main(void) {
                gl_Position = uMVMatrix * vec4(aVertexPosition, 1.0);
            }
        </script>

        <script type="text/javascript" src="hexgrid.js"></script>
		<script type="text/javascript">
			var generatedMap = [];

			for(var i=-2; i < 2; i++){
				for(var j=-2; j < 2; j++){
					generatedMap.push({ x: i, y: j, z: 0});
				}
			}

		</script>
		<script type="text/javascript">
			var size = 25;
			$('#canvas').click(function(e){


				var x = e.pageX - this.offsetLeft;
				var y = e.pageY - this.offsetTop;

				var hexCoor = pixelToHex(x, y);
				var hex = hexGrid.find(hexCoor.q, hexCoor.r);
				//console.log(x, y, hexCoor) ;
				if(!hex){
					return;
				}
				if(hex.color == 'white'){
					hex.color = 'green';
				}
				else{
					hex.color = 'white';
				}
				/*console.log(x, y);

				var preQ = (1/3*Math.sqrt(3) * x + -1/3 * y) / scale;
				var preR = 2/3 * y /scale;
				var q = Math.round(preQ);
				var rq = Math.round(-preQ - preR);
				var r = Math.round(preR);

				var hc = hexToCenter(q, rq, r);

				var hex = hexGrid.find(q, r);

				var fuck = getHex(x, y);
				console.log('fuck this: ')
				if(!hex){
					return;
				}
				if(hex.color == 'white'){
					hex.color = 'green';
				}
				else{
					hex.color = 'white';
				}*/
				//console.log(x, y, hexCoor, JSON.stringify(hex)) ;
				//console.log(hexToPixel(1, 1));
				//console.log('---------', pixelToHex(x, y));

			});

			function pixelToHex(x, y){

				//var q = (1/3*Math.sqrt(3) * xy.x + -1/3 * xy.y) / size;
				//var r = 2/3 * xy.y /size;
				/*
				 x = q - (r + r&1) / 2
				 x * 2 = q - (r + r&1)
				 (x * 2) + (r + r&1) = q


				 z = r
				 r = z

				 y = -x-z

				 y = -x - r
				 */
				var halfSize = size/2;
				var q = ((1/3*Math.sqrt(3) * (x - halfSize) - 1/3 * y)) / size;
				var r = (2/3 * y) / size;

				console.log('ix to hex', q, r);
				var ret = {
					q: Math.round(q),
					r: Math.round(r)
				};
				console.log('ix hex floor', ret);
				return ret;
			}

			function hexToPixel(q, r){
				var x = size * Math.sqrt(3) * (q - 0.5 * (r&1));
				var y = size * 3/2 * r;
				return {
					x: x, y: y
				};
			}
			function takeadump(){
				$('#mapDumpee').text(JSON.stringify(hexGrid.getMap()));
			}
		//	$('#saveMap').click(function(){
		//		alert(1)
		//	})

            // thanks javascript % bug...
            // taken from: http://javascript.about.com/od/problemsolving/a/modulobug.htm
            Number.prototype.mod = function(n) {
                return ((this%n)+n)%n;
            }

			var c = document.getElementById('canvas');

            var gridWidth = 7;
            var gridHeight = 6;

            var hexGrid = new HexGrid(c);
            hexGrid.loadMap(generatedMap);


			function render() {
                hexGrid.renderOneFrame();
				window.setTimeout(render, 80);
			}

			var SQRT_3_2 = 0.8660254037844386;

		</script>
		      <br/><br/>        <br/><br/>   <br/><br/>
	<button id='saveMap' onclick="takeadump()">Dump map data</button>        <br/><br/>   <br/><br/>
	<textarea id='mapDumpee' style='width:300px;height:300px;'></textarea>
	</body>
</html>

